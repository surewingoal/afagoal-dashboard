<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">

<head th:include="include::header"></head>
<body class="gray-bg">
<div class="wrapper wrapper-content ">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox">
                <div class="ibox-body">
                    <div class="fixed-table-toolbar">
                        <input type="hidden" id="token_name" th:value="${token_name}"/>
                        <input id="token_id" type="hidden" th:value="${token_id}"/>
                        <input id="top_type" type="hidden" value="10"/>

                        <div class="columns pull-left col-md-8 nopadding">
                            币种名称：
                            <select id="token_select" class="selectpicker" onchange="tokenChange()"
                                    data-live-search="true">
                            </select>

                            TOP类型：
                            <select id="top_type_select" class="selectpicker"
                                    onchange="topTypeChange()"
                                    data-live-search="true">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>

                    </div>

                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>大户持仓比例</h5>
                            <!--<div class="ibox-tools">-->
                            <!--<a class="collapse-link">-->
                            <!--<i class="fa fa-chevron-up"></i>-->
                            <!--</a>-->
                            <!--<a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">-->
                            <!--<i class="fa fa-wrench"></i>-->
                            <!--</a>-->
                            <!--<ul class="dropdown-menu dropdown-user">-->
                            <!--<li><a href="graph_flot.html#">选项1</a>-->
                            <!--</li>-->
                            <!--<li><a href="graph_flot.html#">选项2</a>-->
                            <!--</li>-->
                            <!--</ul>-->
                            <!--&lt;!&ndash;<a class="close-link">&ndash;&gt;-->
                            <!--&lt;!&ndash;<i class="fa fa-times"></i>&ndash;&gt;-->
                            <!--&lt;!&ndash;</a>&ndash;&gt;-->
                            <!--</div>-->
                        </div>
                        <div class="ibox-content">
                            <div style="height:520px;" class="echarts" id="echarts-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:include="include::footer"></div>
<!-- ECharts -->
<script src="/js/plugins/echarts/echarts-all.js"></script>
<script>
    var dates = new Array();
    var percentages = new Array();
    var holders = new Array();
    var echart = echarts.init(document.getElementById("echarts-chart"));
    var prefix = "/blockchain/token_top_percentage";

    $(document).ready(function () {
        initSelect();
        loadEchartData();
    });

    function loadEchartData() {
        var tokenId = $("#token_id").val();
        var topType = $("#top_type").val();
        $.ajax({
                   cache: true,
                   type: "GET",
                   url: prefix + "/echart_list",
                   data: {
                       token_id: tokenId,
                       top_type: topType
                   },
                   async: false,
                   error: function (request) {
                       layer.alert("Connection error");
                   },
                   success: function (data) {
                       $.each(data, function (index, dto) {
                           dates[index] = dto.statisticTime;
                           percentages[index] = dto.percentage;
                           holders[index] = dto.holdNums;
                       });
                       initEcharts();
                   }
               });
    }

    function initEcharts() {
        var tokenName = $("#token_name").val();
        var topType = $("#top_type").val();
        var option = {
            title: {
                text: tokenName + '前' + topType + '持仓比例'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['占比']
            },
            grid: {
                left: '5%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: true,
                axisTick: {onGap: false},
                splitLine: {show: false},
                data: dates
            },
            yAxis: {
                type : 'value',
                name: '％',
                scale: true
            },
            series: [
                {
                    name: '占比',
                    type: 'line',
                    stack: '总量',
                    data: percentages,
                    markPoint: {
                        data: [
                            {type: 'max', name: '最大值'},
                            {type: 'min', name: '最小值'}
                        ]
                    },
                    markLine: {
                        data: [
                            {type: 'average', name: '平均值'}
                        ]
                    },
                    itemStyle:{
                        normal:{
                            lineStyle:{
                                color:'#a94442'
                            }
                        }
                    }
                }
            ]
        };
        echart.setOption(option);
        window.onresize = echart.resize;
    }

    function tokenChange() {
        var token_id = $("#token_select").val();
        var token_name = $("#" + token_id).text();
        $("#token_id").val(token_id);
        $("#token_name").val(token_name);

        loadEchartData();
    }

    function topTypeChange() {
        var top_type = $("#top_type_select").val();
        $("#top_type").val(top_type);

        loadEchartData();
    }

    function initSelect() {
        var select = $("#token_select");
        var option_value;

        $.ajax({
                   url: "/blockchain/token/simple_list",
                   type: "get",
                   success: function (dtos) {
                       $.each(dtos, function (index, dto) {
                           option_value =
                                   '<option id="' + dto.id + '" value="' + dto.id + '">'
                                   + dto.tokenName + '</option>';
                           select.append(option_value);
                       });
                       $("#token_select").selectpicker('refresh');
                   }
               });
    }

</script>
</body>

</html>
